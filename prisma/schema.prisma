generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                @id @default(cuid())
  username              String                @unique
  password              String
  email                 String?               @unique
  firstName             String
  lastName              String
  phoneNumber           String?
  address               String?
  userType              UserType
  isActive              Boolean               @default(true)
  dateOfBirth           DateTime?
  governmentId          String?               @unique
  idType                String?
  barangayResidence     String?
  occupation            String?
  emergencyContact      String?
  emergencyContactPhone String?
  reasonForRegistration String?
  isVerified            Boolean               @default(false)
  verificationToken     String?
  verificationExpiry    DateTime?
  verifiedAt            DateTime?
  verifiedBy            String?
  registrationIp        String?
  lastLoginAt           DateTime?
  lastLoginIp           String?
  loginAttempts         Int                   @default(0)
  lockedUntil           DateTime?
  passwordResetToken    String?
  passwordResetExpiry   DateTime?
  passwordResetOtp      String?
  passwordResetOtpExpiry DateTime?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  fareCalculations      FareCalculation[]
  handledIncidents      Incident[]            @relation("HandledBy")
  reportedIncidents     Incident[]            @relation("ReportedBy")
  uploadedEvidence      Evidence[]            @relation("EvidenceUploader")
  reviewedEvidence      Evidence[]            @relation("EvidenceReviewer")
  verificationLogs      UserVerificationLog[]
  discountCard          DiscountCard?
  createdLocations      Location[]            @relation("LocationCreator")
  verifiedLocations     Location[]            @relation("LocationVerifier")

  @@index([username])
  @@index([userType])
  @@index([isActive])
  @@index([isVerified])
  @@index([createdAt])
  @@index([userType, isActive])
  @@map("users")
}

model Vehicle {
  id                 String            @id @default(cuid())
  plateNumber        String            @unique
  vehicleType        VehicleType
  make               String
  model              String
  year               Int
  color              String
  capacity           Int
  ownerName          String
  ownerContact       String
  driverName         String?
  driverLicense      String?
  isActive           Boolean           @default(true)
  registrationExpiry DateTime
  insuranceExpiry    DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  fareCalculations   FareCalculation[]
  incidents          Incident[]
  permit             Permit?

  @@index([plateNumber])
  @@index([vehicleType])
  @@index([isActive])
  @@index([ownerName])
  @@index([vehicleType, isActive])
  @@map("vehicles")
}

model Incident {
  id            String         @id @default(cuid())
  incidentType  IncidentType
  description   String
  location      String
  coordinates   String?
  reportedById  String
  handledById   String?
  vehicleId     String?
  vehicleType   VehicleType?
  driverLicense String?
  plateNumber   String?
  status        IncidentStatus @default(PENDING)
  evidenceUrls  String[]
  penaltyAmount Decimal?
  remarks       String?
  ticketNumber  String?        @unique
  incidentDate  DateTime
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  resolvedAt    DateTime?
  handledBy     User?          @relation("HandledBy", fields: [handledById], references: [id])
  reportedBy    User           @relation("ReportedBy", fields: [reportedById], references: [id])
  vehicle       Vehicle?       @relation(fields: [vehicleId], references: [id])
  evidence      Evidence[]

  @@index([status])
  @@index([incidentType])
  @@index([reportedById])
  @@index([handledById])
  @@index([plateNumber])
  @@index([incidentDate])
  @@index([createdAt])
  @@index([status, incidentType])
  @@index([status, createdAt])
  @@map("incidents")
}

model Evidence {
  id          String        @id @default(cuid())
  incidentId  String
  fileName    String
  fileUrl     String
  fileType    EvidenceType
  fileSize    Int?
  uploadedBy  String
  status      EvidenceStatus @default(PENDING_REVIEW)
  reviewedBy  String?
  reviewedAt  DateTime?
  remarks     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  incident    Incident      @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  uploader    User          @relation("EvidenceUploader", fields: [uploadedBy], references: [id])
  reviewer    User?         @relation("EvidenceReviewer", fields: [reviewedBy], references: [id])

  @@index([incidentId])
  @@index([status])
  @@index([uploadedBy])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("evidence")
}

model FareCalculation {
  id              String            @id @default(cuid())
  userId          String?
  vehicleId       String?
  fromLocation    String
  toLocation      String
  distance        Decimal
  calculatedFare  Decimal
  actualFare      Decimal?
  calculationType String
  routeData       String?
  discountCardId  String?
  originalFare    Decimal?
  discountApplied Decimal?
  discountType    DiscountType?
  createdAt       DateTime          @default(now())
  user            User?             @relation(fields: [userId], references: [id])
  vehicle         Vehicle?          @relation(fields: [vehicleId], references: [id])
  discountCard    DiscountCard?     @relation("DiscountedCalculations", fields: [discountCardId], references: [id])
  usageLog        DiscountUsageLog?

  @@index([userId])
  @@index([vehicleId])
  @@index([createdAt])
  @@index([calculationType])
  @@index([discountCardId])
  @@map("fare_calculations")
}

model Route {
  id          String   @id @default(cuid())
  name        String
  description String?
  waypoints   String
  distance    Decimal
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("routes")
}

model Location {
  id                    String              @id @default(cuid())
  name                  String              @unique
  type                  LocationType
  coordinates           String              // Format: "lat,lng"
  barangay              String?
  description           String?
  isActive              Boolean             @default(true)
  
  // Administrative fields
  createdBy             String
  createdByUser         User                @relation("LocationCreator", fields: [createdBy], references: [id])
  verifiedBy            String?
  verifiedByUser        User?               @relation("LocationVerifier", fields: [verifiedBy], references: [id])
  verifiedAt            DateTime?
  
  // Google Maps validation
  googlePlaceId         String?
  googleFormattedAddress String?
  lastValidated         DateTime?
  validationStatus      LocationValidationStatus @default(PENDING)
  
  // Boundary validation
  isWithinMunicipality  Boolean             @default(false)
  isWithinBarangay      Boolean             @default(false)
  actualBarangay        String?
  
  // Metadata
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  validationLogs        LocationValidation[]
  
  @@index([barangay])
  @@index([isActive])
  @@index([validationStatus])
  @@index([createdBy])
  @@map("locations")
}

model LocationValidation {
  id                    String   @id @default(cuid())
  locationId            String
  location              Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  validatedBy           String
  validationType        String   // "CREATION", "UPDATE", "PERIODIC_CHECK"
  
  // Validation results
  isValid               Boolean
  validationErrors      String[] // JSON array of error messages
  validationWarnings    String[] // JSON array of warning messages
  
  // Boundary check results
  withinMunicipality    Boolean
  withinBarangay        Boolean
  detectedBarangay      String?
  
  // Google Maps results
  googleMapsValid       Boolean?
  googlePlaceId         String?
  googleAddress         String?
  googleConfidence      String?  // "high", "medium", "low"
  
  // Coordinates at time of validation
  validatedCoordinates  String
  
  validatedAt           DateTime @default(now())
  
  @@index([locationId])
  @@index([validatedAt])
  @@map("location_validations")
}

model UserVerificationLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  performedBy String
  reason      String?
  evidence    String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_verification_logs")
}

model AdminUserCreation {
  id            String    @id @default(cuid())
  requestedBy   String
  userType      UserType
  firstName     String
  lastName      String
  phoneNumber   String
  department    String?
  position      String?
  employeeId    String?
  notes         String?
  isActive      Boolean   @default(false)
  approvedBy    String?
  approvedAt    DateTime?
  createdUserId String?
  createdAt     DateTime  @default(now())

  @@map("admin_user_creations")
}

model Permit {
  id                 String       @id @default(cuid())
  vehicleId          String       @unique
  permitPlateNumber  String       @unique
  driverFullName     String
  vehicleType        VehicleType
  issuedDate         DateTime     @default(now())
  expiryDate         DateTime
  status             PermitStatus @default(ACTIVE)
  remarks            String?
  encodedBy          String
  encodedAt          DateTime     @default(now())
  lastUpdatedBy      String?
  lastUpdatedAt      DateTime?
  renewalHistory     PermitRenewal[]
  vehicle            Vehicle      @relation(fields: [vehicleId], references: [id])
  
  @@index([status])
  @@index([vehicleType])
  @@index([permitPlateNumber])
  @@index([expiryDate])
  @@index([status, vehicleType])
  @@map("permits")
}

model PermitRenewal {
  id            String   @id @default(cuid())
  permitId      String
  previousExpiry DateTime
  newExpiry      DateTime
  renewedBy     String
  renewedAt     DateTime @default(now())
  notes         String?
  permit        Permit   @relation(fields: [permitId], references: [id], onDelete: Cascade)
  
  @@map("permit_renewals")
}

enum UserType {
  ADMIN
  DATA_ENCODER
  ENFORCER
  PUBLIC
}

enum VehicleType {
  JEEPNEY
  TRICYCLE
  HABAL_HABAL
  MULTICAB
  BUS
  VAN
}

enum IncidentType {
  FARE_OVERCHARGE
  FARE_UNDERCHARGE
  RECKLESS_DRIVING
  VEHICLE_VIOLATION
  ROUTE_VIOLATION
  OTHER
}

enum IncidentStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  DISMISSED
}

enum LocationType {
  BARANGAY
  LANDMARK
  URBAN
  RURAL
}

enum LocationValidationStatus {
  PENDING
  VALIDATED
  FAILED
  NEEDS_REVIEW
}

enum PermitStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  REVOKED
}

enum EvidenceType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

enum EvidenceStatus {
  PENDING_REVIEW
  VERIFIED
  REJECTED
  REQUIRES_ADDITIONAL
}

model DiscountCard {
  id                    String              @id @default(cuid())
  userId                String              @unique
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  discountType          DiscountType
  
  // Identification Details
  idNumber              String?             @unique
  idType                String?
  issuingAuthority      String?
  
  // Supporting Information
  fullName              String
  dateOfBirth           DateTime
  photoUrl              String?
  
  // Student-specific
  schoolName            String?
  schoolAddress         String?
  gradeLevel            String?
  schoolIdExpiry        DateTime?
  
  // PWD-specific
  disabilityType        String?
  pwdIdExpiry           DateTime?
  
  // Verification Status
  verificationStatus    VerificationStatus  @default(PENDING)
  verifiedBy            String?
  verifiedAt            DateTime?
  verificationNotes     String?
  rejectionReason       String?
  
  // Admin Override Feature
  isAdminOverride       Boolean             @default(false)
  overrideReason        String?
  overrideBy            String?
  overrideAt            DateTime?
  
  // Validity
  isActive              Boolean             @default(false)
  validFrom             DateTime
  validUntil            DateTime
  
  // Usage Tracking (Anti-abuse)
  lastUsedAt            DateTime?
  usageCount            Int                 @default(0)
  dailyUsageCount       Int                 @default(0)
  lastResetDate         DateTime?
  
  // Audit Trail
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  fareCalculations      FareCalculation[]   @relation("DiscountedCalculations")
  usageLogs             DiscountUsageLog[]
  
  @@index([userId])
  @@index([discountType])
  @@index([verificationStatus])
  @@index([isActive])
  @@index([validUntil])
  @@index([isAdminOverride])
  @@map("discount_cards")
}

model DiscountUsageLog {
  id                String          @id @default(cuid())
  discountCardId    String
  discountCard      DiscountCard    @relation(fields: [discountCardId], references: [id], onDelete: Cascade)
  
  fareCalculationId String          @unique
  fareCalculation   FareCalculation @relation(fields: [fareCalculationId], references: [id])
  
  originalFare      Decimal         @db.Decimal(10, 2)
  discountAmount    Decimal         @db.Decimal(10, 2)
  finalFare         Decimal         @db.Decimal(10, 2)
  discountRate      Decimal         @db.Decimal(5, 2)
  
  fromLocation      String
  toLocation        String
  distance          Decimal         @db.Decimal(10, 2)
  
  // Anti-fraud tracking
  usedAt            DateTime        @default(now())
  ipAddress         String?
  deviceFingerprint String?
  gpsCoordinates    String?
  
  // Flags for suspicious activity
  isSuspicious      Boolean         @default(false)
  suspiciousReason  String?
  reviewedBy        String?
  reviewedAt        DateTime?
  
  @@index([discountCardId, usedAt])
  @@index([usedAt])
  @@map("discount_usage_logs")
}

enum DiscountType {
  SENIOR_CITIZEN
  PWD
  STUDENT
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  SUSPENDED
  EXPIRED
}
